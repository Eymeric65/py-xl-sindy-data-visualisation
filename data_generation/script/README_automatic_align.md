# Automatic Alignment Batch Processing

The `automatic_align.py` script provides automated batch processing of alignment tasks using `align_data.py`. It processes all experiment JSON/PKL file pairs and runs alignment for each algorithm, regression type, and noise level combination.

## Key Features

### ✅ **Smart Regression Type Selection**
- **Zero force vectors**: Only runs `implicit` and `mixed` regression
- **Non-zero force vectors**: Only runs `explicit` and `mixed` regression
- Automatically analyzes `forces_scale_vector` in each experiment

### ✅ **Comprehensive Parameter Space**
- **Algorithms**: `mixed`, `xlsindy`, `sindy` (configurable)
- **Regression types**: Automatically determined by force vector type
- **Noise levels**: Multiple levels for robustness testing
- **All combinations** processed systematically

### ✅ **Flexible Constraints**
- Whitelist specific algorithms via `--algorithms`
- Constrain regression types via `--regression-types`
- Customize noise levels via `--noise-levels`
- Control parallelization with `--max-workers`

### ✅ **Robust Execution**
- **Dry run mode** for testing without execution
- **Parallel processing** with configurable worker count
- **Skip already completed** experiments
- **Comprehensive error handling** and timeout protection
- **Detailed progress tracking** and statistics

## Usage Examples

### Basic Usage (All Experiments)
```bash
# Run all alignments on all experiments
python -m data_generation.script.automatic_align

# Dry run to see what would be executed
python -m data_generation.script.automatic_align --dry-run --verbose
```

### Constrained Execution
```bash
# Only run mixed algorithm with low noise
python -m data_generation.script.automatic_align \\
    --algorithms mixed \\
    --noise-levels 0.0 0.01

# Only implicit/mixed regression with specific algorithms
python -m data_generation.script.automatic_align \\
    --algorithms mixed xlsindy \\
    --regression-types implicit mixed \\
    --noise-levels 0.0
```

### Performance Tuning
```bash
# Single-threaded for debugging
python -m data_generation.script.automatic_align --max-workers 1

# High parallelization for speed
python -m data_generation.script.automatic_align --max-workers 8
```

## Command Line Arguments

### Core Settings
- `--results-dir`: Directory with JSON files (default: `results`)
- `--results-data-dir`: Directory with PKL files (default: `results_data`)

### Algorithm Control
- `--algorithms`: List of algorithms (`mixed`, `xlsindy`, `sindy`)
- `--regression-types`: List of regression types (`implicit`, `explicit`, `mixed`)
- `--noise-levels`: List of noise levels (default: `0.0 0.01 0.05 0.1`)

### Execution Control
- `--max-workers`: Parallel worker count (default: 4)
- `--dry-run`: Print commands without executing
- `--skip-already-done`: Skip completed experiments (default: True)
- `--verbose`: Enable detailed output

### Alignment Parameters
- `--optimization-function`: Regression function (default: `lasso_regression`)
- `--random-seed`: Random seed list (default: `[0]`)
- `--data-ratio`: Data ratio relative to catalog size (default: 2.0)

## Force Vector Logic

The script analyzes each experiment's `forces_scale_vector` to determine allowable regression types:

```python
# Zero forces (e.g., [0, 0, 0])
allowable_regression_types = ["implicit", "mixed"]

# Non-zero forces (e.g., [5, 0, 0] or [5, 5, 5])
allowable_regression_types = ["explicit", "mixed"]
```

## Output & Statistics

The script provides comprehensive statistics:

```
============================================================
EXECUTION SUMMARY  
============================================================
Total alignments: 468
Successful: 468
Failed: 0
Success rate: 100.0%

TIMING:
Average alignment time: 12.34 seconds
Total execution time: 1234.56 seconds
```

## Integration with Existing Workflow

### Relation to `generate_list.sh`
The script processes files generated by `generate_list.sh`, automatically handling:
- Multiple experiment folders (`cart_pole`, `double_pendulum_pm`, `cart_pole_double`)
- Different damping coefficients 
- Various force scale patterns
- All random seeds

### Alignment Command Format
Each alignment follows the same pattern as manual `align_data.py` calls:
```bash
python -m data_generation.script.align_data \\
    --experiment-file results/<experiment_id> \\
    --algorithm mixed \\
    --regression-type explicit \\
    --noise-level 0.01 \\
    --optimization-function lasso_regression \\
    --data-ratio 2.0 \\
    --random-seed 0 \\
    --skip-already-done
```

## Error Handling

- **Timeout protection**: 5-minute timeout per alignment
- **Missing files**: Warns about JSON files without corresponding PKL files
- **Execution failures**: Continues with remaining alignments, reports at end
- **Graceful degradation**: Processes available files even if some are corrupted

## Best Practices

### For Development/Testing
```bash
# Start with dry run and constraints
python -m data_generation.script.automatic_align \\
    --dry-run --verbose \\
    --algorithms mixed \\
    --noise-levels 0.0 \\
    --max-workers 1
```

### For Production Runs
```bash
# Full batch with appropriate parallelization
python -m data_generation.script.automatic_align \\
    --max-workers 4 \\
    --verbose
```

### For Specific Studies
```bash
# Focus on specific configurations
python -m data_generation.script.automatic_align \\
    --algorithms xlsindy sindy \\  
    --regression-types explicit \\
    --noise-levels 0.0 0.05 0.1
```

This tool significantly reduces manual effort in running systematic alignment studies across the entire experimental parameter space.